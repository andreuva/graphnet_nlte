/*
 *  Generates 3D snapshot from 3DMHD 385 data for the CaII module of PORTA
 *
 *  PMD version: 2
 *
 *  NOTE: the CaII populations are only known for Z-planes between 52 and 476
 *
 */

#include <stdlib.h>
#include <stdio.h>
#include <math.h>

#define EVERYNTH  1 /*168*/
#define OUT_FILE      "AR_385_CAII.pmd"

#define MAXNX     8192
#define NXY       504
#define NZ1       52    //min. available index in CaII populations
#define NZ2       476   //max. available index in CaII populations
#define IZ1       70    //first index included in the model (-100 km)
#define IZ2       330   //last index included (+5000 km)
#define NZ        (IZ2-IZ1+1)
#define NZMAX     496

#define MAX_LTE_TEMP    10000.0

#if (IZ1<NZ1 || IZ2>NZ2)
#	error "ivalid Z-interval"
#endif
#define RERR(x)   {fprintf(stderr,"READING ERROR (%d)\n",x); exit(1);}

const int g_pops[5] = {0,1,7,13,14};
const int g_J2[5] = {1,3,5,1,3};
const double g_E[5] = {0, 2.712304609237728e-12, 2.724372462548765e-12, 5.00554158522362e-12, 5.049837128374757e-12};

static const double gXY[NXY] = {0.00000,4.76190e+06,9.52381e+06,1.42857e+07,1.90476e+07,2.38095e+07,2.85714e+07,3.33333e+07,3.80952e+07,4.28571e+07
		,4.76191e+07,5.23810e+07,5.71429e+07,6.19048e+07,6.66667e+07,7.14286e+07,7.61905e+07,8.09524e+07,8.57143e+07,9.04762e+07
		,9.52381e+07,1.00000e+08,1.04762e+08,1.09524e+08,1.14286e+08,1.19048e+08,1.23810e+08,1.28571e+08,1.33333e+08,1.38095e+08
		,1.42857e+08,1.47619e+08,1.52381e+08,1.57143e+08,1.61905e+08,1.66667e+08,1.71429e+08,1.76190e+08,1.80952e+08,1.85714e+08
		,1.90476e+08,1.95238e+08,2.00000e+08,2.04762e+08,2.09524e+08,2.14286e+08,2.19048e+08,2.23810e+08,2.28571e+08,2.33333e+08
		,2.38095e+08,2.42857e+08,2.47619e+08,2.52381e+08,2.57143e+08,2.61905e+08,2.66667e+08,2.71429e+08,2.76190e+08,2.80952e+08
		,2.85714e+08,2.90476e+08,2.95238e+08,3.00000e+08,3.04762e+08,3.09524e+08,3.14286e+08,3.19048e+08,3.23810e+08,3.28571e+08
		,3.33333e+08,3.38095e+08,3.42857e+08,3.47619e+08,3.52381e+08,3.57143e+08,3.61905e+08,3.66667e+08,3.71429e+08,3.76190e+08
		,3.80952e+08,3.85714e+08,3.90476e+08,3.95238e+08,4.00000e+08,4.04762e+08,4.09524e+08,4.14286e+08,4.19048e+08,4.23809e+08
		,4.28571e+08,4.33333e+08,4.38095e+08,4.42857e+08,4.47619e+08,4.52381e+08,4.57143e+08,4.61905e+08,4.66667e+08,4.71429e+08
		,4.76191e+08,4.80952e+08,4.85714e+08,4.90476e+08,4.95238e+08,5.00000e+08,5.04762e+08,5.09524e+08,5.14286e+08,5.19048e+08
		,5.23809e+08,5.28571e+08,5.33333e+08,5.38095e+08,5.42857e+08,5.47619e+08,5.52381e+08,5.57143e+08,5.61905e+08,5.66667e+08
		,5.71429e+08,5.76191e+08,5.80952e+08,5.85714e+08,5.90476e+08,5.95238e+08,6.00012e+08,6.04774e+08,6.09536e+08,6.14298e+08
		,6.19060e+08,6.23822e+08,6.28583e+08,6.33345e+08,6.38107e+08,6.42869e+08,6.47631e+08,6.52393e+08,6.57155e+08,6.61917e+08
		,6.66679e+08,6.71441e+08,6.76202e+08,6.80964e+08,6.85726e+08,6.90488e+08,6.95250e+08,7.00012e+08,7.04774e+08,7.09536e+08
		,7.14298e+08,7.19060e+08,7.23821e+08,7.28583e+08,7.33345e+08,7.38107e+08,7.42869e+08,7.47631e+08,7.52393e+08,7.57155e+08
		,7.61917e+08,7.66679e+08,7.71441e+08,7.76202e+08,7.80964e+08,7.85726e+08,7.90488e+08,7.95250e+08,8.00012e+08,8.04774e+08
		,8.09536e+08,8.14298e+08,8.19060e+08,8.23821e+08,8.28583e+08,8.33345e+08,8.38107e+08,8.42869e+08,8.47631e+08,8.52393e+08
		,8.57155e+08,8.61917e+08,8.66679e+08,8.71441e+08,8.76202e+08,8.80964e+08,8.85726e+08,8.90488e+08,8.95250e+08,9.00012e+08
		,9.04774e+08,9.09536e+08,9.14298e+08,9.19060e+08,9.23821e+08,9.28583e+08,9.33345e+08,9.38107e+08,9.42869e+08,9.47631e+08
		,9.52393e+08,9.57155e+08,9.61917e+08,9.66679e+08,9.71441e+08,9.76202e+08,9.80964e+08,9.85726e+08,9.90488e+08,9.95250e+08
		,1.00001e+09,1.00477e+09,1.00954e+09,1.01430e+09,1.01906e+09,1.02382e+09,1.02858e+09,1.03335e+09,1.03811e+09,1.04287e+09
		,1.04763e+09,1.05239e+09,1.05716e+09,1.06192e+09,1.06668e+09,1.07144e+09,1.07620e+09,1.08096e+09,1.08573e+09,1.09049e+09
		,1.09525e+09,1.10001e+09,1.10477e+09,1.10954e+09,1.11430e+09,1.11906e+09,1.12382e+09,1.12858e+09,1.13335e+09,1.13811e+09
		,1.14287e+09,1.14763e+09,1.15239e+09,1.15716e+09,1.16192e+09,1.16668e+09,1.17144e+09,1.17620e+09,1.18096e+09,1.18573e+09
		,1.19049e+09,1.19525e+09,1.20002e+09,1.20479e+09,1.20955e+09,1.21431e+09,1.21907e+09,1.22383e+09,1.22859e+09,1.23336e+09
		,1.23812e+09,1.24288e+09,1.24764e+09,1.25240e+09,1.25717e+09,1.26193e+09,1.26669e+09,1.27145e+09,1.27621e+09,1.28098e+09
		,1.28574e+09,1.29050e+09,1.29526e+09,1.30002e+09,1.30479e+09,1.30955e+09,1.31431e+09,1.31907e+09,1.32383e+09,1.32859e+09
		,1.33336e+09,1.33812e+09,1.34288e+09,1.34764e+09,1.35240e+09,1.35717e+09,1.36193e+09,1.36669e+09,1.37145e+09,1.37621e+09
		,1.38098e+09,1.38574e+09,1.39050e+09,1.39526e+09,1.40002e+09,1.40479e+09,1.40955e+09,1.41431e+09,1.41907e+09,1.42383e+09
		,1.42859e+09,1.43336e+09,1.43812e+09,1.44288e+09,1.44764e+09,1.45240e+09,1.45717e+09,1.46193e+09,1.46669e+09,1.47145e+09
		,1.47621e+09,1.48098e+09,1.48574e+09,1.49050e+09,1.49526e+09,1.50002e+09,1.50479e+09,1.50955e+09,1.51431e+09,1.51907e+09
		,1.52383e+09,1.52859e+09,1.53336e+09,1.53812e+09,1.54288e+09,1.54764e+09,1.55240e+09,1.55717e+09,1.56193e+09,1.56669e+09
		,1.57145e+09,1.57621e+09,1.58098e+09,1.58574e+09,1.59050e+09,1.59526e+09,1.60002e+09,1.60479e+09,1.60955e+09,1.61431e+09
		,1.61907e+09,1.62383e+09,1.62859e+09,1.63336e+09,1.63812e+09,1.64288e+09,1.64764e+09,1.65240e+09,1.65717e+09,1.66193e+09
		,1.66669e+09,1.67145e+09,1.67621e+09,1.68098e+09,1.68574e+09,1.69050e+09,1.69526e+09,1.70002e+09,1.70479e+09,1.70955e+09
		,1.71431e+09,1.71907e+09,1.72383e+09,1.72859e+09,1.73336e+09,1.73812e+09,1.74288e+09,1.74764e+09,1.75240e+09,1.75717e+09
		,1.76193e+09,1.76669e+09,1.77145e+09,1.77621e+09,1.78098e+09,1.78574e+09,1.79050e+09,1.79526e+09,1.80004e+09,1.80480e+09
		,1.80956e+09,1.81432e+09,1.81908e+09,1.82384e+09,1.82861e+09,1.83337e+09,1.83813e+09,1.84289e+09,1.84765e+09,1.85242e+09
		,1.85718e+09,1.86194e+09,1.86670e+09,1.87146e+09,1.87623e+09,1.88099e+09,1.88575e+09,1.89051e+09,1.89527e+09,1.90004e+09
		,1.90480e+09,1.90956e+09,1.91432e+09,1.91908e+09,1.92384e+09,1.92861e+09,1.93337e+09,1.93813e+09,1.94289e+09,1.94765e+09
		,1.95242e+09,1.95718e+09,1.96194e+09,1.96670e+09,1.97146e+09,1.97623e+09,1.98099e+09,1.98575e+09,1.99051e+09,1.99527e+09
		,2.00004e+09,2.00480e+09,2.00956e+09,2.01432e+09,2.01908e+09,2.02384e+09,2.02861e+09,2.03337e+09,2.03813e+09,2.04289e+09
		,2.04765e+09,2.05242e+09,2.05718e+09,2.06194e+09,2.06670e+09,2.07146e+09,2.07623e+09,2.08099e+09,2.08575e+09,2.09051e+09
		,2.09527e+09,2.10004e+09,2.10480e+09,2.10956e+09,2.11432e+09,2.11908e+09,2.12384e+09,2.12861e+09,2.13337e+09,2.13813e+09
		,2.14289e+09,2.14765e+09,2.15242e+09,2.15718e+09,2.16194e+09,2.16670e+09,2.17146e+09,2.17623e+09,2.18099e+09,2.18575e+09
		,2.19051e+09,2.19527e+09,2.20004e+09,2.20480e+09,2.20956e+09,2.21432e+09,2.21908e+09,2.22384e+09,2.22861e+09,2.23337e+09
		,2.23813e+09,2.24289e+09,2.24765e+09,2.25242e+09,2.25718e+09,2.26194e+09,2.26670e+09,2.27146e+09,2.27623e+09,2.28099e+09
		,2.28575e+09,2.29051e+09,2.29527e+09,2.30004e+09,2.30480e+09,2.30956e+09,2.31432e+09,2.31908e+09,2.32384e+09,2.32861e+09
		,2.33337e+09,2.33813e+09,2.34289e+09,2.34765e+09,2.35242e+09,2.35718e+09,2.36194e+09,2.36670e+09,2.37146e+09,2.37623e+09
		,2.38099e+09,2.38575e+09,2.39051e+09,2.39527e+09};

static const double gZ_minus[NZMAX] = {1.43671e+09,1.42699e+09,1.41731e+09,1.40768e+09,1.39808e+09,1.38852e+09,1.37899e+09,1.36951e+09,1.36006e+09,1.35065e+09
		,1.34128e+09,1.33195e+09,1.32265e+09,1.31339e+09,1.30417e+09,1.29498e+09,1.28583e+09,1.27672e+09,1.26764e+09,1.25860e+09
		,1.24959e+09,1.24062e+09,1.23169e+09,1.22279e+09,1.21393e+09,1.20510e+09,1.19631e+09,1.18755e+09,1.17883e+09,1.17014e+09
		,1.16149e+09,1.15287e+09,1.14429e+09,1.13574e+09,1.12722e+09,1.11874e+09,1.11030e+09,1.10188e+09,1.09350e+09,1.08515e+09
		,1.07684e+09,1.06856e+09,1.06031e+09,1.05210e+09,1.04391e+09,1.03576e+09,1.02764e+09,1.01956e+09,1.01151e+09,1.00349e+09
		,9.95521e+08,9.87649e+08,9.79871e+08,9.72184e+08,9.64589e+08,9.57084e+08,9.49668e+08,9.42340e+08,9.35098e+08,9.27943e+08
		,9.20873e+08,9.13886e+08,9.06982e+08,9.00160e+08,8.93419e+08,8.86758e+08,8.80176e+08,8.73671e+08,8.67244e+08,8.60894e+08
		,8.54618e+08,8.48417e+08,8.42290e+08,8.36235e+08,8.30252e+08,8.24339e+08,8.18497e+08,8.12725e+08,8.07020e+08,8.01384e+08
		,7.95814e+08,7.90310e+08,7.84871e+08,7.79497e+08,7.74187e+08,7.68940e+08,7.63755e+08,7.58631e+08,7.53568e+08,7.48565e+08
		,7.43622e+08,7.38737e+08,7.33910e+08,7.29140e+08,7.24427e+08,7.19770e+08,7.15168e+08,7.10620e+08,7.06126e+08,7.01686e+08
		,6.97298e+08,6.92963e+08,6.88679e+08,6.84445e+08,6.80262e+08,6.76128e+08,6.72044e+08,6.68008e+08,6.64019e+08,6.60078e+08
		,6.56184e+08,6.52336e+08,6.48534e+08,6.44776e+08,6.41063e+08,6.37394e+08,6.33769e+08,6.30187e+08,6.26647e+08,6.23149e+08
		,6.19693e+08,6.16277e+08,6.12903e+08,6.09568e+08,6.06272e+08,6.03016e+08,5.99798e+08,5.96619e+08,5.93477e+08,5.90373e+08
		,5.87305e+08,5.84273e+08,5.81278e+08,5.78318e+08,5.75393e+08,5.72503e+08,5.69647e+08,5.66826e+08,5.64037e+08,5.61282e+08
		,5.58559e+08,5.55868e+08,5.53210e+08,5.50583e+08,5.47987e+08,5.45422e+08,5.42887e+08,5.40382e+08,5.37907e+08,5.35462e+08
		,5.33045e+08,5.30657e+08,5.28298e+08,5.25966e+08,5.23662e+08,5.21385e+08,5.19136e+08,5.16912e+08,5.14716e+08,5.12545e+08
		,5.10400e+08,5.08281e+08,5.06187e+08,5.04117e+08,5.02072e+08,5.00051e+08,4.98051e+08,4.96051e+08,4.94052e+08,4.92052e+08
		,4.90052e+08,4.88052e+08,4.86052e+08,4.84052e+08,4.82052e+08,4.80052e+08,4.78052e+08,4.76052e+08,4.74052e+08,4.72052e+08
		,4.70052e+08,4.68052e+08,4.66052e+08,4.64052e+08,4.62052e+08,4.60052e+08,4.58052e+08,4.56052e+08,4.54052e+08,4.52052e+08
		,4.50052e+08,4.48052e+08,4.46052e+08,4.44052e+08,4.42052e+08,4.40052e+08,4.38052e+08,4.36052e+08,4.34052e+08,4.32052e+08
		,4.30052e+08,4.28052e+08,4.26052e+08,4.24052e+08,4.22052e+08,4.20053e+08,4.18053e+08,4.16053e+08,4.14053e+08,4.12053e+08
		,4.10053e+08,4.08053e+08,4.06053e+08,4.04053e+08,4.02053e+08,4.00053e+08,3.98053e+08,3.96053e+08,3.94053e+08,3.92053e+08
		,3.90053e+08,3.88053e+08,3.86053e+08,3.84053e+08,3.82053e+08,3.80053e+08,3.78053e+08,3.76053e+08,3.74053e+08,3.72053e+08
		,3.70053e+08,3.68053e+08,3.66053e+08,3.64053e+08,3.62053e+08,3.60053e+08,3.58053e+08,3.56053e+08,3.54053e+08,3.52053e+08
		,3.50053e+08,3.48053e+08,3.46054e+08,3.44054e+08,3.42054e+08,3.40054e+08,3.38054e+08,3.36054e+08,3.34054e+08,3.32054e+08
		,3.30054e+08,3.28054e+08,3.26054e+08,3.24054e+08,3.22054e+08,3.20054e+08,3.18054e+08,3.16054e+08,3.14054e+08,3.12054e+08
		,3.10054e+08,3.08054e+08,3.06054e+08,3.04054e+08,3.02054e+08,3.00054e+08,2.98054e+08,2.96054e+08,2.94054e+08,2.92054e+08
		,2.90054e+08,2.88054e+08,2.86054e+08,2.84054e+08,2.82054e+08,2.80054e+08,2.78054e+08,2.76054e+08,2.74054e+08,2.72054e+08
		,2.70054e+08,2.68055e+08,2.66055e+08,2.64055e+08,2.62055e+08,2.60055e+08,2.58055e+08,2.56055e+08,2.54055e+08,2.52055e+08
		,2.50055e+08,2.48055e+08,2.46055e+08,2.44055e+08,2.42055e+08,2.40055e+08,2.38055e+08,2.36055e+08,2.34055e+08,2.32055e+08
		,2.30055e+08,2.28055e+08,2.26055e+08,2.24055e+08,2.22055e+08,2.20055e+08,2.18055e+08,2.16055e+08,2.14055e+08,2.12055e+08
		,2.10055e+08,2.08055e+08,2.06055e+08,2.04055e+08,2.02055e+08,2.00055e+08,1.98055e+08,1.96055e+08,1.94055e+08,1.92055e+08
		,1.90055e+08,1.88055e+08,1.86056e+08,1.84056e+08,1.82056e+08,1.80056e+08,1.78056e+08,1.76056e+08,1.74056e+08,1.72056e+08
		,1.70056e+08,1.68056e+08,1.66056e+08,1.64056e+08,1.62056e+08,1.60056e+08,1.58056e+08,1.56056e+08,1.54056e+08,1.52056e+08
		,1.50056e+08,1.48056e+08,1.46056e+08,1.44056e+08,1.42056e+08,1.40056e+08,1.38056e+08,1.36056e+08,1.34056e+08,1.32056e+08
		,1.30056e+08,1.28056e+08,1.26056e+08,1.24056e+08,1.22056e+08,1.20056e+08,1.18056e+08,1.16056e+08,1.14056e+08,1.12056e+08
		,1.10056e+08,1.08056e+08,1.06056e+08,1.04056e+08,1.02056e+08,1.00056e+08,9.80563e+07,9.60564e+07,9.40564e+07,9.20564e+07
		,9.00565e+07,8.80565e+07,8.60565e+07,8.40566e+07,8.20566e+07,8.00566e+07,7.80566e+07,7.60567e+07,7.40572e+07,7.20594e+07
		,7.00642e+07,6.80727e+07,6.60860e+07,6.41042e+07,6.21270e+07,6.01438e+07,5.81630e+07,5.61835e+07,5.42041e+07,5.22242e+07
		,5.02438e+07,4.82712e+07,4.63052e+07,4.43444e+07,4.23878e+07,4.04348e+07,3.84841e+07,3.65347e+07,3.45862e+07,3.26384e+07
		,3.06907e+07,2.87425e+07,2.67938e+07,2.48440e+07,2.28931e+07,2.09408e+07,1.89883e+07,1.70368e+07,1.50899e+07,1.31573e+07
		,1.12505e+07,9.36722e+06,7.49832e+06,5.63705e+06,3.77289e+06,1.89377e+06,-0.00000,-1.90094e+06,-3.80524e+06,-5.71121e+06
		,-7.61810e+06,-9.52545e+06,-1.14326e+07,-1.33389e+07,-1.52440e+07,-1.71477e+07,-1.90500e+07,-2.09515e+07,-2.28522e+07,-2.47520e+07
		,-2.66510e+07,-2.85487e+07,-3.04452e+07,-3.23407e+07,-3.42352e+07,-3.61291e+07,-3.80229e+07,-3.99175e+07,-4.18138e+07,-4.37134e+07
		,-4.56172e+07,-4.75262e+07,-4.94411e+07,-5.13626e+07,-5.32919e+07,-5.52302e+07,-5.71793e+07,-5.91405e+07,-6.11157e+07,-6.31070e+07
		,-6.51164e+07,-6.71464e+07,-6.91998e+07,-7.12793e+07,-7.33878e+07,-7.55278e+07,-7.77022e+07,-7.99138e+07,-8.21657e+07,-8.44614e+07
		,-8.68047e+07,-8.91994e+07,-9.16496e+07,-9.41598e+07,-9.67348e+07,-9.93796e+07,-1.02100e+08,-1.04900e+08,-1.07786e+08,-1.10762e+08
		,-1.13835e+08,-1.17009e+08,-1.20293e+08,-1.23693e+08,-1.27216e+08,-1.30870e+08,-1.34661e+08,-1.38597e+08,-1.42685e+08,-1.46933e+08
		,-1.51349e+08,-1.55942e+08,-1.60721e+08,-1.65696e+08,-1.70875e+08,-1.76270e+08,-1.81889e+08,-1.87744e+08,-1.93845e+08,-2.00203e+08
		,-2.06828e+08,-2.13734e+08,-2.20932e+08,-2.28433e+08,-2.36252e+08,-2.44401e+08};

static double gZ[NZMAX];

/* writes NXY/EVERYNTH coordinates to f */
static void
WriteXYAxisCoords(FILE *f)
{
	int i = 0;
	while (i<NXY)
	{
		if (i % EVERYNTH == 0) fwrite(&gXY[i], sizeof(double), 1, f);
		i++;
	}
}

void
WritePMDHeader(FILE *f)
{
	char magic[] = "portapmd";
	char module[1023] = "CaII5L";
	int i, j, cnt;
	char c;
	double d;
	fprintf(stderr, "writing PMD header\n");
	fwrite(magic, 1, 8, f);  //magic string
	c = 0;
	fwrite(&c, 1, 1, f); //little endian
	c = sizeof(int);
	fwrite(&c, 1, 1, f);  //size of integer type
	c = sizeof(double);
	fwrite(&c, 1, 1, f);  //size of double type
	i = 2;
	fwrite(&i, sizeof(int), 1, f);  //version of PMD
	i = 0;
	for (j=0; j<6; j++) fwrite(&i, sizeof(int), 1, f);  //date
	c = 1;
	fwrite(&c, 1, 1, f);
	fwrite(&c, 1, 1, f);  //periodicity
	d = (gXY[NXY-1]-gXY[0])/(NXY-1) * NXY;
	fwrite(&d, sizeof(double), 1, f);  // DX
	fwrite(&d, sizeof(double), 1, f);  // DY
	d = gZ[IZ2] - gZ[IZ1];
	fwrite(&d, sizeof(double), 1, f);  // DZ
	d = 0;
	fwrite(&d, sizeof(double), 1, f);  // X0
	fwrite(&d, sizeof(double), 1, f);  // Y0
	d = gZ[IZ1];
	fwrite(&d, sizeof(double), 1, f);  // Z0
	i = NXY / EVERYNTH;
	fwrite(&i, sizeof(int), 1, f);  //NX
	fwrite(&i, sizeof(int), 1, f);  //NY
	i = NZ;
	fwrite(&i, sizeof(int), 1, f);  //NZ
	d=0;
	WriteXYAxisCoords(f);
	for (i=NXY/EVERYNTH; i<MAXNX; i++) fwrite(&d, sizeof(double), 1, f);
	WriteXYAxisCoords(f);
	for (i=NXY/EVERYNTH; i<MAXNX; i++) fwrite(&d, sizeof(double), 1, f);
	cnt = 0;
	d = 0;
	i = IZ1;
	while (cnt<MAXNX)
	{
		if (i<=IZ2) { fwrite(&gZ[i], sizeof(double), 1, f); cnt++; i++; }
		else { fwrite(&d, sizeof(double), 1, f); cnt++; }
	}
	i = 5;
	fwrite(&i, sizeof(int), 1, f);  //N_theta
	i = 4;
	fwrite(&i, sizeof(int), 1, f);  //N_chi
	fwrite(module, 1, 1023, f);  //N_chi
	c = 0;
	for (i=0; i<4096; i++) fwrite(&c, 1, 1, f);
	i = 3*sizeof(int) + 2*(NXY/EVERYNTH)*sizeof(double) + (NXY/EVERYNTH)*(NXY/EVERYNTH)*sizeof(double);
	fwrite(&i, sizeof(int), 1, f);  //module header size
	i = 584;
	fwrite(&i, sizeof(int), 1, f);  //module node data size
}

void
WriteCaIIHeader(FILE *f, FILE *f_temp)
{
	int i, j;
	float rovina[NXY*NXY];
	fprintf(stderr, "writing CaII5L header\n");
	i=1;
	fwrite(&i, sizeof(int), 1, f);  //module version
	i = NXY/EVERYNTH;
	fwrite(&i, sizeof(int), 1, f);  //NX
	fwrite(&i, sizeof(int), 1, f);  //NY
	WriteXYAxisCoords(f);
	WriteXYAxisCoords(f);
	for (i=0; i<=IZ1; i++) fread(rovina, sizeof(float), NXY*NXY, f_temp);
	for (j=0; j<NXY; j++)
	{
		for (i=0; i<NXY; i++)
		{
			double d = rovina[NXY*j+i];
			if (i%EVERYNTH==0 && j%EVERYNTH==0)
			{
				fwrite(&d, sizeof(double), 1, f);
			}
		}
	}
	fseek(f_temp, 0, SEEK_SET);
}

void
CalcZ(void)
{
	int i;
	fprintf(stderr, "recalculating Z axis\n");
	for (i=0; i<NZMAX; i++) gZ[i] = gZ_minus[NZMAX-i-1];
}

void
SetLTE(double T, double dm[])
{
	int i;
	double sum;
	for (i=0; i<20; i++) dm[i] = 0;
	sum = 0;
	for (i=0; i<5; i++)
	{
		double Tr = (T <= MAX_LTE_TEMP ? T : MAX_LTE_TEMP);
Tr = T;
		dm[g_pops[i]] = ((double)(g_J2[i]+1))/(g_J2[0]+1) * exp(-(g_E[i]-g_E[0])/1.38e-16/Tr)  *  1.0/sqrt(1.0+g_J2[i]);
		sum += dm[g_pops[i]] * sqrt(1.0+g_J2[i]);
	}
	for (i=0; i<5; i++) dm[g_pops[i]] = dm[g_pops[i]]/sum;

}

void
NormDM(double dm[])
{
    int i;
    double s=0;
    for (i=0; i<5; i++)	s += dm[g_pops[i]] * sqrt(1.0+g_J2[i]);
    for (i=0; i<5; i++) dm[g_pops[i]] /= s;
}

#define IERR {fprintf(stderr, "INTERNAL ERROR\n"); exit(1);}

int
main (int argc, char *argv[])
{
	int i, j, k;
	FILE *f;

	FILE *f_e=fopen("AR_385_ne.dat","rb"),*f_hi=fopen("AR_385_nh.dat","rb"),*f_temp=fopen("AR_385_temp.dat","rb"),
			*f_B=fopen("AR_385_B.dat","rb"),*f_v=fopen("AR_385_veloc.dat","rb"),*f_contopac=fopen("CAII_OPACITY.DAT","rb"),
			*f_pops=fopen("AR_385_CaII_5L_pops.dat","rb");

	/*FILE *f_e=fopen("/home/jiri/AR_385/AR_385_ne.dat","rb"),*f_hi=fopen("/home/jiri/AR_385/AR_385_nh.dat","rb"),*f_temp=fopen("/home/jiri/AR_385/AR_385_temp.dat","rb"),
				*f_B=fopen("/home/jiri/AR_385/AR_385_B.dat","rb"),*f_v=fopen("/home/jiri/AR_385/AR_385_veloc.dat","rb"),*f_contopac=fopen("/home/jiri/AR_385/CAII_OPACITY.DAT","rb"),
				*f_pops=fopen("/home/jiri/AR_385/AR_385_CaII_5L_pops.dat","rb");*/

	if (EVERYNTH!=1)
	{
		fprintf(stderr, "WARNING: Only every %dth horizontal point is included in the model!\n", EVERYNTH);
	}
	if (NXY % EVERYNTH)
	{
		fprintf(stderr, "ERROR: invalid coarsening\n");
		exit(1);
	}

	f = fopen(OUT_FILE, "wb");
	if (!f)
	{
		fprintf(stderr, "cannot open file for writing\n");
		exit(1);
	}
	if (!f_e || !f_hi || !f_temp || !f_B || !f_v || !f_contopac || !f_pops)
	{
		fprintf(stderr, "cannot open file for reading\n");
		exit(1);
	}


	CalcZ();
	WritePMDHeader(f);
	WriteCaIIHeader(f, f_temp);

	fprintf(stderr, "writing grid nodes\n");
	double dm[20], jkq[5*9];

	for (i=0; i<5*9; i++) jkq[i] = 0;

	for (k=0; k<NZMAX; k++)
	{
//double Ta = 0;
		if (k>IZ2) goto konec;
		fprintf(stderr, "%d, ", k);
		for (j=0; j<NXY; j++)
		{
			for (i=0; i<NXY; i++)
			{
				float caii[6], ne, hi, temp, micro=0, b[3], v[3], cont[5];
				float fl, ff[16];
				int m;
				if (!fread(&ne, sizeof(float), 1, f_e)) RERR(1);
				if (!fread(&hi, sizeof(float), 1, f_hi)) RERR(2);
				if (!fread(&temp, sizeof(float), 1, f_temp)) RERR(3);
				if (fread(b, sizeof(float), 3, f_B)!=3) RERR(4);
				if (fread(v, sizeof(float), 3, f_v)!=3) RERR(5);
				if (fread(cont, sizeof(float), 5, f_contopac)!=5) RERR(6);
//Ta += temp/NXY/NXY;
				if (k<NZ1) continue;

				int rrr;
				if ((rrr=fread(caii, sizeof(float), 6, f_pops))!=6)
				{
				    fprintf(stderr, "%d %d %d (%d)\n", i,j,k,rrr);
				    RERR(7);
				}

				if (k<IZ1) continue;
				if ((i%EVERYNTH) || (j%EVERYNTH)) continue;

				fl = caii[0]+caii[1]+caii[2]+caii[3]+caii[4];
				ff[0] = fl;
				ff[1] = ne;
				ff[2] = hi;
				ff[3] = temp;
				ff[4] = micro;
				ff[5] = b[0]; ff[6] = b[1]; ff[7] = b[2];
				ff[8] = v[0]; ff[9] = v[1]; ff[10]= v[2];
				/* module : {"(8662)", "(8542)", "(8498)", "H (3969)", "K (3934)"}; */
				/* file:  H, K, 8498, 8542, 8662. */
				ff[11]=cont[4];ff[12]=cont[3];ff[13]=cont[2];ff[14]=cont[0];ff[15]=cont[1];
				fwrite(ff, sizeof(float), 16, f);

				//SetLTE(temp, dm);
				for (m=0; m<20; m++) dm[m] = 0;
				dm[g_pops[0]] = caii[0]/fl * 1.0/sqrt(1.0+g_J2[0]);
				dm[g_pops[1]] = caii[1]/fl * 1.0/sqrt(1.0+g_J2[1]);
				dm[g_pops[2]] = caii[2]/fl * 1.0/sqrt(1.0+g_J2[2]);
				dm[g_pops[3]] = caii[3]/fl * 1.0/sqrt(1.0+g_J2[3]);
				dm[g_pops[4]] = caii[4]/fl * 1.0/sqrt(1.0+g_J2[4]);
				NormDM(dm);
				if (
				    isnan(dm[g_pops[0]]) || dm[g_pops[0]]<=0 ||
				    isnan(dm[g_pops[1]]) || dm[g_pops[1]]<=0 ||
				    isnan(dm[g_pops[2]]) || dm[g_pops[2]]<=0 ||
				    isnan(dm[g_pops[3]]) || dm[g_pops[3]]<=0 ||
				    isnan(dm[g_pops[4]]) || dm[g_pops[4]]<=0
				    )
				  {
				    fprintf(stderr, "Internal Error !\n");
				  }
				fwrite(dm, sizeof(double), 20, f);  //dm
				fwrite(jkq, sizeof(double), 5*9, f);  //JKQ * 5
			}
		}
//printf("z=%e\tT=%e\n", gZ[k]/1e5, Ta);
	}
	konec:
	fclose(f);
	fprintf(stderr, "\ndone\n");

	return 0;
}
